float(float exponent) LvlForExp =
{	
	return sqrt(exponent/80) + 1;
};
float(float lvel) ExpForLevel =
{
	return (lvel * lvel) * 80;
};
float(entity att, entity targ, float expu) GiveExp =
{
	local float e;
	local entity oself, f;
	oself = self;
	if (att.health < 1)
		return 0;
	if (expu <= 0)
		return 0;
		

	if ((att.flags & FL_CLIENT) && (expu == targ.exp))
	{
		f = find(world, classname, "dummy");
		while (f)
		{
			if (att != f.owner)
				if (friendly(att.player, f))
					GiveExp(f.owner, targ, expu * 0.5);
			f = find(f, classname, "dummy");
		}
	}
	if (att.player.sbarsub)
		GiveExp(att.player.sbarsub.owner, targ, expu);
	if (targ)
	{
		e = 1 - (att.lvl - targ.lvl) * 0.1;
	
		if (e < 0)
			e = 0;
		else if (e > 1)
			e = 1;
	}
	if (targ.flags & FL_CLIENT)
		e = 10;
	else
		e = e * expu;
		
	if (att.skill & SKILL_EXPERIENCE)
		e = e + e * (att.title_x + 1) / 6;
	e = ceil(e);
	
	if ((att.exp + e) < 800000)
	{
		att.exp = att.exp + e;
		if (self.options & OPT_VERBOSE)
		{
			sprint(att, "You gain ");
			sprint(att, ftos(e));
			sprint(att, " experience\n");
		}		
	}
	else
		att.exp = 800000;
	while ((att.exp >= ExpForLevel(att.lvl)) && (att.lvl <= MAX_CHAR_LEVEL))
	{
		
		// fix autogenerated stats
		self = att;
		Unstat();
		att.lvl = att.lvl + 1;
		Restat();
		self = oself;
		
		att.health = att.max_health;
		att.mana = att.max_mana; // whee!
		att.options = att.options - (att.options & OPT_SEEN_PTD);
		
		if (att.netname)
		{
			bprint(att.netname, " has advanced to level ", ftos(att.lvl), "\n");
			sound(att, CHAN_AUTO, "player/levelup.wav", 1, ATTN_NONE);
		}
		att.ptd = att.ptd + 5;
		if (att.ptd > 127)
			att.ptd = 127;
	}
	return e;
};
